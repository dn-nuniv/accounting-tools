<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B/Sãƒ»P/L æ§‹æˆå›³ ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .stack-outer{height:560px}
    .stack-col{flex:1 1 50%;min-width:0;display:flex;flex-direction:column;justify-content:flex-end}
    .stack-box{width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:13px;line-height:1.2;color:#1f2937;padding:4px 6px;text-align:center}
    .lbl-small{font-size:12px}.lbl-tiny{font-size:11px}.lbl-micro{font-size:10px}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <h1 class="text-2xl md:text-3xl font-bold mb-4">B/Sãƒ»P/L æ§‹æˆå›³ v2.3.1</h1>

    <div class="mb-4 flex flex-wrap gap-4 items-center">
      <div class="flex items-center gap-3">
        <span class="text-sm font-semibold">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:</span>
        <label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="mode" value="single" class="accent-sky-600" checked>å˜ç¤¾</label>
        <label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="mode" value="compare" class="accent-sky-600">2ç¤¾æ¯”è¼ƒ</label>
      </div>
      <div id="compareTypeBlock" class="hidden flex items-center gap-3">
        <span class="text-sm font-semibold">æ¯”è¼ƒã‚¿ã‚¤ãƒ—:</span>
        <label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="compareType" value="ratio" class="accent-indigo-600" checked>æ§‹æˆæ¯”</label>
        <label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="compareType" value="scale" class="accent-indigo-600">è¦æ¨¡ï¼ˆæœ€å¤§=100ï¼‰</label>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
      <!-- INPUT -->
      <section class="lg:col-span-2 card p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-2">1. å…¥åŠ›</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div class="sm:col-span-2"><label class="text-sm text-slate-600">ä¼æ¥­åï¼ˆAï¼‰</label><input id="companyA" class="w-full border rounded-lg px-3 py-2" value="Aç¤¾"></div>
          <div class="sm:col-span-2"><label class="text-sm text-slate-600">å¯¾è±¡å¹´åº¦ï¼ˆAï¼‰</label><input id="fiscalA" class="w-full border rounded-lg px-3 py-2" value="2024å¹´3æœˆæœŸ"></div>
        </div>
        <div class="mt-3 flex flex-wrap items-center gap-3">
          <div><label class="text-sm text-slate-600 mr-1">å˜ä½</label>
            <select id="unit" class="border rounded-lg px-3 py-2">
              <option value="åƒå††">åƒå††</option>
              <option value="ç™¾ä¸‡å††">ç™¾ä¸‡å††</option>
              <option value="å„„å††" selected>å„„å††</option>
            </select>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <span class="text-sm font-semibold">è‡ªå·±è³‡æœ¬æ¯”ç‡ã®è¨ˆç®—:</span>
            <label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="erMode" value="simple" class="accent-sky-600" checked>ç°¡ç•¥ï¼ˆç´”è³‡ç”£/ç·è³‡ç”£ï¼‰</label>
            <label class="inline-flex items-center gap-1 text-sm"><input type="radio" name="erMode" value="principle" class="accent-sky-600">åŸå‰‡ï¼ˆç´”è³‡ç”£âˆ’æ–°æ ªäºˆç´„æ¨©âˆ’éæ”¯é…æ ªä¸»æŒåˆ†ï¼‰/ç·è³‡ç”£</label>
          </div>
        </div>

        <div class="mt-4">
          <h3 class="font-semibold mb-1">é€£çµè²¸å€Ÿå¯¾ç…§è¡¨ï¼ˆAï¼‰</h3>
          <div class="grid grid-cols-2 gap-3 bg-slate-50 border rounded-xl p-4">
            <div><label class="text-sm text-slate-600">æµå‹•è³‡ç”£</label><input id="caA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="467"></div>
            <div><label class="text-sm text-slate-600">å›ºå®šè³‡ç”£</label><input id="faA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="806"></div>
            <div><label class="text-sm text-slate-600">æµå‹•è² å‚µ</label><input id="clA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="304"></div>
            <div><label class="text-sm text-slate-600">å›ºå®šè² å‚µ</label><input id="flA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="162"></div>
            <div class="col-span-2"><label class="text-sm text-slate-600">ç´”è³‡ç”£</label><input id="naA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="807"></div>
            <div class="col-span-2"><label class="text-sm text-slate-600">æ–°æ ªäºˆç´„æ¨©</label><input id="soA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="0"></div>
            <div class="col-span-2"><label class="text-sm text-slate-600">éæ”¯é…æ ªä¸»æŒåˆ†</label><input id="nciA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="0"></div>
          </div>
        </div>
        <div class="mt-3">
          <h3 class="font-semibold mb-1">é€£çµæç›Šè¨ˆç®—æ›¸ï¼ˆAï¼‰</h3>
          <div class="grid grid-cols-2 gap-3 bg-slate-50 border rounded-xl p-4">
            <div class="col-span-2"><label class="text-sm text-slate-600">å£²ä¸Šé«˜</label><input id="salesA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="2702"></div>
            <div><label class="text-sm text-slate-600">å£²ä¸ŠåŸä¾¡</label><input id="cogsA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="1931"></div>
            <div><label class="text-sm text-slate-600">è²©ç®¡è²»</label><input id="sgaA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="648"></div>
            <div class="col-span-2"><label class="text-sm text-slate-600">å–¶æ¥­åˆ©ç›Š</label><input id="opA" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="123"></div>
          </div>
        </div>

        <!-- B company block -->
        <div id="companyBBlock" class="mt-8 hidden">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="sm:col-span-2"><label class="text-sm text-slate-600">ä¼æ¥­åï¼ˆBï¼‰</label><input id="companyB" class="w-full border rounded-lg px-3 py-2" value="Bç¤¾"></div>
            <div class="sm:col-span-2"><label class="text-sm text-slate-600">å¯¾è±¡å¹´åº¦ï¼ˆBï¼‰</label><input id="fiscalB" class="w-full border rounded-lg px-3 py-2" value="2024å¹´3æœˆæœŸ"></div>
          </div>
          <div class="mt-3">
            <h3 class="font-semibold mb-1">é€£çµè²¸å€Ÿå¯¾ç…§è¡¨ï¼ˆBï¼‰</h3>
            <div class="grid grid-cols-2 gap-3 bg-slate-50 border rounded-xl p-4">
              <div><label class="text-sm text-slate-600">æµå‹•è³‡ç”£</label><input id="caB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="900"></div>
              <div><label class="text-sm text-slate-600">å›ºå®šè³‡ç”£</label><input id="faB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="1100"></div>
              <div><label class="text-sm text-slate-600">æµå‹•è² å‚µ</label><input id="clB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="700"></div>
              <div><label class="text-sm text-slate-600">å›ºå®šè² å‚µ</label><input id="flB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="300"></div>
              <div class="col-span-2"><label class="text-sm text-slate-600">ç´”è³‡ç”£</label><input id="naB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="1000"></div>
              <div class="col-span-2"><label class="text-sm text-slate-600">æ–°æ ªäºˆç´„æ¨©</label><input id="soB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="0"></div>
              <div class="col-span-2"><label class="text-sm text-slate-600">éæ”¯é…æ ªä¸»æŒåˆ†</label><input id="nciB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="0"></div>
            </div>
          </div>
          <div class="mt-3">
            <h3 class="font-semibold mb-1">é€£çµæç›Šè¨ˆç®—æ›¸ï¼ˆBï¼‰</h3>
            <div class="grid grid-cols-2 gap-3 bg-slate-50 border rounded-xl p-4">
              <div class="col-span-2"><label class="text-sm text-slate-600">å£²ä¸Šé«˜</label><input id="salesB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="5000"></div>
              <div><label class="text-sm text-slate-600">å£²ä¸ŠåŸä¾¡</label><input id="cogsB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="3800"></div>
              <div><label class="text-sm text-slate-600">è²©ç®¡è²»</label><input id="sgaB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="1000"></div>
              <div class="col-span-2"><label class="text-sm text-slate-600">å–¶æ¥­åˆ©ç›Š</label><input id="opB" type="number" step="0.1" class="w-full border rounded-lg px-3 py-2" value="200"></div>
            </div>
          </div>
        </div>

        <div class="mt-6 flex flex-col sm:flex-row gap-3">
          <button id="btnGenerate" class="rounded-xl bg-sky-600 hover:bg-sky-700 text-white font-semibold px-4 py-2">ä½œå›³ã™ã‚‹</button>
          <button id="btnExport" class="rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-4 py-2 disabled:opacity-40" disabled>PNGã§ä¿å­˜</button>
          <button id="btnReset" class="rounded-xl bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold px-4 py-2">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <p id="msg" class="mt-2 text-sm text-rose-600"></p>
      </section>

      <!-- OUTPUT -->
      <section class="lg:col-span-3 card p-4 md:p-6">
        <h2 class="text-lg font-semibold mb-2">2. ç”Ÿæˆçµæœ</h2>

        <div id="metaSingle" class="mb-3 hidden">
          <div id="titleTextS" class="text-xl font-bold"></div>
          <div id="subtitleTextS" class="text-sm text-slate-500"></div>
        </div>
        <div id="metaCompare" class="mb-3 hidden text-center">
          <div id="titleTextC" class="text-xl font-bold"></div>
          <div id="subtitleTextC" class="text-sm text-slate-500"></div>
        </div>

        <div id="captureSingle" class="hidden select-none">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-semibold text-center mb-2">é€£çµè²¸å€Ÿå¯¾ç…§è¡¨ï¼ˆæ§‹æˆæ¯”ï¼‰</h3>
              <div class="h-[560px] flex items-end"><div id="bsOuterS" class="w-full stack-outer border rounded-xl overflow-hidden bg-white">
                <div class="h-full flex w-full items-stretch">
                  <div class="stack-col border-r border-slate-200">
                    <div id="box-caS" class="stack-box border-b border-sky-200" style="background:#e8f3ff;height:50%">æµå‹•è³‡ç”£</div>
                    <div id="box-faS" class="stack-box" style="background:#cfe6ff;height:50%">å›ºå®šè³‡ç”£</div>
                  </div>
                  <div class="stack-col">
                    <div id="box-clS" class="stack-box border-b border-pink-200" style="background:#ffe7f0;height:33%">æµå‹•è² å‚µ</div>
                    <div id="box-flS" class="stack-box border-b border-pink-200" style="background:#ffd1e1;height:17%">å›ºå®šè² å‚µ</div>
                    <div id="box-naS" class="stack-box" style="background:#e8f8ef;height:50%">ç´”è³‡ç”£</div>
                  </div>
                </div>
              </div></div>
              <div id="legendBsS" class="mt-3"></div>
            </div>
            <div>
              <h3 class="font-semibold text-center mb-2">é€£çµæç›Šè¨ˆç®—æ›¸ï¼ˆæ§‹æˆæ¯”ï¼‰</h3>
              <div class="h-[560px] flex items-end"><div id="plOuterS" class="w-full stack-outer border rounded-xl overflow-hidden bg-white">
                <div class="h-full flex w-full items-stretch">
                  <div class="stack-col border-r border-amber-200">
                    <div id="box-cogsS" class="stack-box border-b border-amber-200" style="background:#ffe4bc;height:70%">å£²ä¸ŠåŸä¾¡</div>
                    <div id="box-sgaS" class="stack-box border-b border-amber-200" style="background:#ffd38a;height:24%">è²©ç®¡è²»</div>
                    <div id="box-opS" class="stack-box" style="background:#fff6bf;height:6%">å–¶æ¥­åˆ©ç›Š</div>
                  </div>
                  <div class="stack-col">
                    <div id="box-salesS" class="stack-box" style="background:#dcf7df;height:100%">å£²ä¸Šé«˜ï¼ˆ100%ï¼‰</div>
                  </div>
                </div>
              </div></div>
              <div id="legendPlS" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div id="captureCompare" class="hidden select-none">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <h3 class="font-semibold text-center mb-2"><span id="hdrA" class="text-sky-700">ä¼šç¤¾A</span> â€” é€£çµè²¸å€Ÿå¯¾ç…§è¡¨ï¼ˆæ§‹æˆæ¯”ï¼‰</h3>
              <div class="h-[560px] flex items-end"><div id="bsOuterA" class="w-full stack-outer border rounded-xl overflow-hidden bg-white">
                <div class="h-full flex w-full items-stretch">
                  <div class="stack-col border-r border-slate-200">
                    <div id="box-caA2" class="stack-box border-b border-sky-200" style="background:#e8f3ff;height:50%">æµå‹•è³‡ç”£</div>
                    <div id="box-faA" class="stack-box" style="background:#cfe6ff;height:50%">å›ºå®šè³‡ç”£</div>
                  </div>
                  <div class="stack-col">
                    <div id="box-clA" class="stack-box border-b border-pink-200" style="background:#ffe7f0;height:33%">æµå‹•è² å‚µ</div>
                    <div id="box-flA" class="stack-box border-b border-pink-200" style="background:#ffd1e1;height:17%">å›ºå®šè² å‚µ</div>
                    <div id="box-naA" class="stack-box" style="background:#e8f8ef;height:50%">ç´”è³‡ç”£</div>
                  </div>
                </div>
              </div></div>
              <div id="legendBsA" class="mt-3"></div>
            </div>
            <div>
              <h3 class="font-semibold text-center mb-2"><span id="hdrB" class="text-rose-700">ä¼šç¤¾B</span> â€” é€£çµè²¸å€Ÿå¯¾ç…§è¡¨ï¼ˆæ§‹æˆæ¯”ï¼‰</h3>
              <div class="h-[560px] flex items-end"><div id="bsOuterB" class="w-full stack-outer border rounded-xl overflow-hidden bg-white">
                <div class="h-full flex w-full items-stretch">
                  <div class="stack-col border-r border-slate-200">
                    <div id="box-caB2" class="stack-box border-b border-sky-200" style="background:#e8f3ff;height:50%">æµå‹•è³‡ç”£</div>
                    <div id="box-faB" class="stack-box" style="background:#cfe6ff;height:50%">å›ºå®šè³‡ç”£</div>
                  </div>
                  <div class="stack-col">
                    <div id="box-clB" class="stack-box border-b border-pink-200" style="background:#ffe7f0;height:33%">æµå‹•è² å‚µ</div>
                    <div id="box-flB" class="stack-box border-b border-pink-200" style="background:#ffd1e1;height:17%">å›ºå®šè² å‚µ</div>
                    <div id="box-naB2" class="stack-box" style="background:#e8f8ef;height:50%">ç´”è³‡ç”£</div>
                  </div>
                </div>
              </div></div>
              <div id="legendBsB" class="mt-3"></div>
            </div>
            <div>
              <h3 class="font-semibold text-center mb-2">é€£çµæç›Šè¨ˆç®—æ›¸ï¼ˆæ§‹æˆæ¯”ï¼‰</h3>
              <div class="h-[560px] flex items-end"><div id="plOuterA" class="w-full stack-outer border rounded-xl overflow-hidden bg-white">
                <div class="h-full flex w-full items-stretch">
                  <div class="stack-col border-r border-amber-200">
                    <div id="box-cogsA" class="stack-box border-b border-amber-200" style="background:#ffe4bc;height:70%">å£²ä¸ŠåŸä¾¡</div>
                    <div id="box-sgaA" class="stack-box border-b border-amber-200" style="background:#ffd38a;height:24%">è²©ç®¡è²»</div>
                    <div id="box-opA" class="stack-box" style="background:#fff6bf;height:6%">å–¶æ¥­åˆ©ç›Š</div>
                  </div>
                  <div class="stack-col">
                    <div id="box-salesA" class="stack-box" style="background:#dcf7df;height:100%">å£²ä¸Šé«˜ï¼ˆ100%ï¼‰</div>
                  </div>
                </div>
              </div></div>
              <div id="legendPlA" class="mt-3"></div>
            </div>
            <div>
              <h3 class="font-semibold text-center mb-2">é€£çµæç›Šè¨ˆç®—æ›¸ï¼ˆæ§‹æˆæ¯”ï¼‰</h3>
              <div class="h-[560px] flex items-end"><div id="plOuterB" class="w-full stack-outer border rounded-xl overflow-hidden bg-white">
                <div class="h-full flex w-full items-stretch">
                  <div class="stack-col border-r border-amber-200">
                    <div id="box-cogsB" class="stack-box border-b border-amber-200" style="background:#ffe4bc;height:70%">å£²ä¸ŠåŸä¾¡</div>
                    <div id="box-sgaB" class="stack-box border-b border-amber-200" style="background:#ffd38a;height:24%">è²©ç®¡è²»</div>
                    <div id="box-opB" class="stack-box" style="background:#fff6bf;height:6%">å–¶æ¥­åˆ©ç›Š</div>
                  </div>
                  <div class="stack-col">
                    <div id="box-salesB" class="stack-box" style="background:#dcf7df;height:100%">å£²ä¸Šé«˜ï¼ˆ100%ï¼‰</div>
                  </div>
                </div>
              </div></div>
              <div id="legendPlB" class="mt-3"></div>
            </div>
          </div>
        </div>

        <div class="mt-8 card p-4">
          <h3 class="font-semibold mb-2">--- AIè§£é‡ˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ---</h3>
          <textarea id="promptArea" class="w-full h-56 border rounded p-2 font-mono text-[13px]"></textarea>
          <div class="mt-2 flex items-center gap-2">
            <button id="btnCopy" class="px-3 py-2 rounded bg-slate-800 text-white">ğŸ“‹ ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
            <span id="copyMsg" class="text-sm text-slate-500"></span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (n)=> new Intl.NumberFormat('ja-JP').format(Number(n));
    const pct = (n)=> (Number(n).toFixed(1) + '%');

    const readMainMode = ()=> (document.querySelector('input[name="mode"]:checked')||{}).value || 'single';
    const readCompareType = ()=> (document.querySelector('input[name="compareType"]:checked')||{}).value || 'ratio';
    const readErMode = ()=> (document.querySelector('input[name="erMode"]:checked')||{}).value || 'simple';

    const validate = (d)=>{ const TA=d.ca+d.fa, TR=d.cl+d.fl+d.na; const msgs=[]; if(Math.abs(TA-TR)>0.5) msgs.push(`è²¸å€Ÿå¯¾ç…§è¡¨ãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ï¼šè³‡ç”£åˆè¨ˆ ${fmt(TA)} / è² å‚µç´”è³‡ç”£åˆè¨ˆ ${fmt(TR)}`); const pl=d.cogs+d.sga+d.op; if(Math.abs(d.sales-pl)>0.5) msgs.push(`æç›Šè¨ˆç®—æ›¸ãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ï¼šè²»ç”¨ï¼‹åˆ©ç›Šåˆè¨ˆ ${fmt(pl)} / å£²ä¸Šé«˜ ${fmt(d.sales)}`); return msgs; };

    function labelHTML(name,val,percent,px,unit){ if(px<22){return `<div class="lbl-micro">(${pct(percent)})</div>`;} else if(px<36){return `<div class="lbl-tiny"><div class="font-semibold">${name}</div><div>(${pct(percent)})</div></div>`;} else if(px<64){return `<div class="lbl-small"><div class="font-semibold">${name}</div><div>${fmt(val)} ${unit}</div></div>`;} else {return `<div class="font-semibold">${name}</div><div>${fmt(val)} ${unit}</div><div>(${pct(percent)})</div>`;} }

    const equityRatio = (asset, na, so, nci, mode)=>{ if(!asset) return 0; const num = (mode==='principle') ? (na - so - nci) : na; return num / asset * 100; };

    const readA = ()=>({ company:$('companyA').value.trim()||'â€”', fiscal:$('fiscalA').value.trim()||'â€”', ca:+$('caA').value||0, fa:+$('faA').value||0, cl:+$('clA').value||0, fl:+$('flA').value||0, na:+$('naA').value||0, so:+$('soA').value||0, nci:+$('nciA').value||0, sales:+$('salesA').value||0, cogs:+$('cogsA').value||0, sga:+$('sgaA').value||0, op:+$('opA').value||0 });
    const readB = ()=>({ company:$('companyB').value.trim()||'â€”', fiscal:$('fiscalB').value.trim()||'â€”', ca:+$('caB').value||0, fa:+$('faB').value||0, cl:+$('clB').value||0, fl:+$('flB').value||0, na:+$('naB').value||0, so:+$('soB').value||0, nci:+$('nciB').value||0, sales:+$('salesB').value||0, cogs:+$('cogsB').value||0, sga:+$('sgaB').value||0, op:+$('opB').value||0 });

    function setBox(id,name,val,pctv,unit){ const el=$(id); el.style.height=pctv+'%'; const h=el.clientHeight; el.innerHTML=labelHTML(name,val,pctv,h,unit); }

    function legendBsHTML(label, ca, fa, cl, fl, na, unit, erOverride){ const asset=ca+fa; const debt=cl+fl; const er=(erOverride!=null)?erOverride:(asset?na/asset*100:0); return `<div class=\"card p-4\"><h4 class=\"font-semibold text-[17px] mb-2\">ã€${label}ã€‘B/S æ˜ç´°</h4><p class=\"mb-1\">è³‡ç”£åˆè¨ˆï¼š<span class=\"font-bold text-[18px]\">${fmt(asset)} ${unit}</span>ï¼ˆæµå‹• ${fmt(ca)}ï¼å›ºå®š ${fmt(fa)}ï¼‰</p><p class=\"mb-1\">è² å‚µåˆè¨ˆï¼š<span class=\"font-bold text-[18px]\">${fmt(debt)} ${unit}</span>ï¼ˆæµå‹• ${fmt(cl)}ï¼å›ºå®š ${fmt(fl)}ï¼‰</p><p>ç´”è³‡ç”£ï¼š<span class=\"font-bold text-[18px]\">${fmt(na)} ${unit}</span>ï½œè‡ªå·±è³‡æœ¬æ¯”ç‡ï¼š<span class=\"font-bold\">${pct(er)}</span></p></div>`; }
    function legendPlHTML(label, sales, cogs, sga, op, unit){ const gp=sales-cogs; const gpr=sales? gp/sales*100:0; const opr=sales? op/sales*100:0; const sgar=sales? sga/sales*100:0; return `<div class=\"card p-4\"><h4 class=\"font-semibold text-[17px] mb-2\">ã€${label}ã€‘P/L æ˜ç´°</h4><p class=\"mb-1\">å£²ä¸Šç·åˆ©ç›Šï¼ˆç²—åˆ©ï¼‰ï¼š<span class=\"font-bold text-[18px]\">${fmt(gp)} ${unit}</span>ï¼ˆç²—åˆ©ç‡ ${pct(gpr)}ï¼‰</p><p class=\"mb-1\">è²©ç®¡è²»ç‡ï¼š<span class=\"font-bold\">${pct(sgar)}</span></p><p>å–¶æ¥­åˆ©ç›Šç‡ï¼š<span class=\"font-bold\">${pct(opr)}</span></p></div>`; }

    function renderLegendsSingle(d, unit, er){ $('legendBsS').innerHTML = legendBsHTML(d.company,d.ca,d.fa,d.cl,d.fl,d.na,unit,er); $('legendPlS').innerHTML = legendPlHTML(d.company,d.sales,d.cogs,d.sga,d.op,unit); }
    function renderLegendsCompare(A,B, unit, erA, erB){ $('legendBsA').innerHTML = legendBsHTML(A.company,A.ca,A.fa,A.cl,A.fl,A.na,unit,erA); $('legendBsB').innerHTML = legendBsHTML(B.company,B.ca,B.fa,B.cl,B.fl,B.na,unit,erB); $('legendPlA').innerHTML = legendPlHTML(A.company,A.sales,A.cogs,A.sga,A.op,unit); $('legendPlB').innerHTML = legendPlHTML(B.company,B.sales,B.cogs,B.sga,B.op,unit); }
    function clearAllLegends(){ ['legendBsS','legendPlS','legendBsA','legendBsB','legendPlA','legendPlB'].forEach(id=>{const el=$(id); if(el) el.innerHTML='';}); }

    function renderSingle(){
      const unit=$('unit').value; const d=readA(); const err=validate(d);
      $('msg').textContent = err.join('\n');
      if(err.length){ $('captureSingle').classList.add('hidden'); $('btnExport').disabled=true; $('metaSingle').classList.add('hidden'); clearAllLegends(); return; }
      $('metaCompare').classList.add('hidden'); $('metaSingle').classList.remove('hidden');
      $('titleTextS').textContent=`${d.company}ã€€${d.fiscal}`; $('subtitleTextS').textContent=`å˜ä½ï¼š${unit}`;
      const TA=d.ca+d.fa; const caPct=TA?d.ca/TA*100:0, faPct=TA?d.fa/TA*100:0, clPct=TA?d.cl/TA*100:0, flPct=TA?d.fl/TA*100:0, naPct=TA?d.na/TA*100:0; const cogsPct=d.sales?d.cogs/d.sales*100:0, sgaPct=d.sales?d.sga/d.sales*100:0, opPct=d.sales?d.op/d.sales*100:0; const base=560, maxScale=Math.max(TA,d.sales,1); const hBS=Math.round(Math.max(60,base*(TA/maxScale))); const hPL=Math.round(Math.max(60,base*(d.sales/maxScale))); $('bsOuterS').style.height=hBS+'px'; $('plOuterS').style.height=hPL+'px'; $('captureSingle').classList.remove('hidden'); requestAnimationFrame(()=>{ setBox('box-caS','æµå‹•è³‡ç”£',d.ca,caPct,unit); setBox('box-faS','å›ºå®šè³‡ç”£',d.fa,faPct,unit); setBox('box-clS','æµå‹•è² å‚µ',d.cl,clPct,unit); setBox('box-flS','å›ºå®šè² å‚µ',d.fl,flPct,unit); setBox('box-naS','ç´”è³‡ç”£',d.na,naPct,unit); setBox('box-cogsS','å£²ä¸ŠåŸä¾¡',d.cogs,cogsPct,unit); setBox('box-sgaS','è²©ç®¡è²»',d.sga,sgaPct,unit); setBox('box-opS','å–¶æ¥­åˆ©ç›Š',d.op,opPct,unit); $('box-salesS').innerHTML=`<div class="font-semibold">å£²ä¸Šé«˜</div><div class="font-semibold">${fmt(d.sales)} ${unit}</div><div>(100%)</div>`; $('btnExport').disabled=false; const erMode=readErMode(); const er=equityRatio(TA,d.na,d.so,d.nci,erMode); renderLegendsSingle(d,unit,er); $('promptArea').value=buildPromptSingle(unit,d,er,erMode); });
    }

    function renderCompare(){
      const unit=$('unit').value; const A=readA(), B=readB(); const errs=[]; validate(A).forEach(m=>errs.push('ä¼šç¤¾A: '+m)); validate(B).forEach(m=>errs.push('ä¼šç¤¾B: '+m)); $('msg').textContent=errs.join('\n'); if(errs.length){$('captureCompare').classList.add('hidden');$('btnExport').disabled=true; $('metaCompare').classList.add('hidden'); clearAllLegends(); return;} $('metaSingle').classList.add('hidden'); $('metaCompare').classList.remove('hidden'); $('titleTextC').textContent=`${A.company} vs ${B.company}`; const compareType=readCompareType(); $('subtitleTextC').textContent=(compareType==='ratio')?`æ¯”è¼ƒã‚¿ã‚¤ãƒ—ï¼šæ§‹æˆæ¯”æ¯”è¼ƒ`:`æ¯”è¼ƒã‚¿ã‚¤ãƒ—ï¼šè¦æ¨¡æ¯”è¼ƒï¼ˆæœ€å¤§=100ï¼‰`; const TAa=A.ca+A.fa, TAb=B.ca+B.fa; const caPctA=TAa?A.ca/TAa*100:0, faPctA=TAa?A.fa/TAa*100:0, clPctA=TAa?A.cl/TAa*100:0, flPctA=TAa?A.fl/TAa*100:0, naPctA=TAa?A.na/TAa*100:0; const caPctB=TAb?B.ca/TAb*100:0, faPctB=TAb?B.fa/TAb*100:0, clPctB=TAb?B.cl/TAb*100:0, flPctB=TAb?B.fl/TAb*100:0, naPctB=TAb?B.na/TAb*100:0; const cogsPctA=A.sales?A.cogs/A.sales*100:0, sgaPctA=A.sales?A.sga/A.sales*100:0, opPctA=A.sales?A.op/A.sales*100:0; const cogsPctB=B.sales?B.cogs/B.sales*100:0, sgaPctB=B.sales?B.sga/B.sales*100:0, opPctB=B.sales?B.op/B.sales*100:0; const base=560; if(compareType==='ratio'){['bsOuterA','plOuterA','bsOuterB','plOuterB'].forEach(id=>{$(id).style.height=base+'px';});} else { const M=Math.max(TAa,A.sales,TAb,B.sales,1); const H=v=>Math.round(Math.max(60,base*(v/M))); $('bsOuterA').style.height=H(TAa)+'px'; $('plOuterA').style.height=H(A.sales)+'px'; $('bsOuterB').style.height=H(TAb)+'px'; $('plOuterB').style.height=H(B.sales)+'px'; } $('captureCompare').classList.remove('hidden'); requestAnimationFrame(()=>{ setBox('box-caA2','æµå‹•è³‡ç”£',A.ca,caPctA,unit); setBox('box-faA','å›ºå®šè³‡ç”£',A.fa,faPctA,unit); setBox('box-clA','æµå‹•è² å‚µ',A.cl,clPctA,unit); setBox('box-flA','å›ºå®šè² å‚µ',A.fl,flPctA,unit); setBox('box-naA','ç´”è³‡ç”£',A.na,naPctA,unit); setBox('box-caB2','æµå‹•è³‡ç”£',B.ca,caPctB,unit); setBox('box-faB','å›ºå®šè³‡ç”£',B.fa,faPctB,unit); setBox('box-clB','æµå‹•è² å‚µ',B.cl,clPctB,unit); setBox('box-flB','å›ºå®šè² å‚µ',B.fl,flPctB,unit); setBox('box-naB2','ç´”è³‡ç”£',B.na,naPctB,unit); setBox('box-cogsA','å£²ä¸ŠåŸä¾¡',A.cogs,cogsPctA,unit); setBox('box-sgaA','è²©ç®¡è²»',A.sga,sgaPctA,unit); setBox('box-opA','å–¶æ¥­åˆ©ç›Š',A.op,opPctA,unit); $('box-salesA').innerHTML=`<div class="font-semibold">å£²ä¸Šé«˜</div><div class="font-semibold">${fmt(A.sales)} ${unit}</div><div>(100%)</div>`; setBox('box-cogsB','å£²ä¸ŠåŸä¾¡',B.cogs,cogsPctB,unit); setBox('box-sgaB','è²©ç®¡è²»',B.sga,sgaPctB,unit); setBox('box-opB','å–¶æ¥­åˆ©ç›Š',B.op,opPctB,unit); $('box-salesB').innerHTML=`<div class="font-semibold">å£²ä¸Šé«˜</div><div class="font-semibold">${fmt(B.sales)} ${unit}</div><div>(100%)</div>`; $('btnExport').disabled=false; const erMode=readErMode(); const erA=equityRatio(TAa,A.na,A.so,A.nci,erMode); const erB=equityRatio(TAb,B.na,B.so,B.nci,erMode); renderLegendsCompare(A,B,unit,erA,erB); $('promptArea').value=buildPromptCompare(unit,A,B,erA,erB,erMode); }); }

    function buildPromptSingle(unit, d, erVal, mode){ const TA=d.ca+d.fa; const gp=d.sales-d.cogs; const cr=d.cl? d.ca/d.cl*100:0; const gpm=d.sales? gp/d.sales*100:0; const opm=d.sales? d.op/d.sales*100:0; const erLabel=(mode==='principle')?'åŸå‰‡':'ç°¡ç•¥'; return `--- AIè§£é‡ˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ---\nä»¥ä¸‹ã¯ã€Œ${d.company}ã€ã®${d.fiscal}ã®è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\næ¥­ç¨®ã¯ä¼šç¤¾åã‹ã‚‰æ¨å®šã—ã¦ãã ã•ã„ã€‚\n\nåˆå¿ƒè€…å‘ã‘ã«ã€è²¡å‹™æ§‹é€ ï¼ˆçŸ­æœŸå®‰å…¨æ€§ï¼æµå‹•æ¯”ç‡ï¼é•·æœŸå®‰å…¨æ€§ï¼è‡ªå·±è³‡æœ¬æ¯”ç‡ï¼‰ã‚„åç›Šæ€§ã®ç‰¹å¾´ã‚’ã‚ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚\n\n--- ãƒ‡ãƒ¼ã‚¿ ---\nç·è³‡ç”£ï¼š${fmt(TA)}${unit}ï¼ˆæµå‹• ${fmt(d.ca)}ï¼å›ºå®š ${fmt(d.fa)}ï¼‰\nè² å‚µåˆè¨ˆï¼š${fmt(d.cl+d.fl)}${unit}ï¼ˆæµå‹• ${fmt(d.cl)}ï¼å›ºå®š ${fmt(d.fl)}ï¼‰\nç´”è³‡ç”£ï¼š${fmt(d.na)}${unit}\nè‡ªå·±è³‡æœ¬æ¯”ç‡ï¼ˆ${erLabel}ï¼‰ï¼š${pct(erVal)}\næµå‹•æ¯”ç‡ï¼š${pct(cr)}\n\nå£²ä¸Šé«˜ï¼š${fmt(d.sales)}${unit}\nå£²ä¸ŠåŸä¾¡ï¼š${fmt(d.cogs)}${unit}\nè²©ç®¡è²»ï¼š${fmt(d.sga)}${unit}\nå–¶æ¥­åˆ©ç›Šï¼š${fmt(d.op)}${unit}\nå£²ä¸Šç·åˆ©ç›Šç‡ï¼š${pct(gpm)}\nå–¶æ¥­åˆ©ç›Šç‡ï¼š${pct(opm)}\n--------------\n\nã€ãŠé¡˜ã„ã—ãŸã„ã“ã¨ã€‘\n1. è²¡å‹™æ§‹é€ ã®ç‰¹å¾´ï¼ˆçŸ­æœŸãƒ»é•·æœŸã®å®‰å…¨æ€§ã‚’å«ã‚ã¦ï¼‰\n2. åç›Šæ€§ã®ç‰¹å¾´ï¼ˆç²—åˆ©ç‡ãƒ»å–¶æ¥­åˆ©ç›Šç‡ï¼‰\n3. æ¥­ç•Œå¹³å‡ã¨æ¯”ã¹ãŸå¼·ã¿ãƒ»å¼±ã¿\n4. åˆå¿ƒè€…ã§ã‚‚ç†è§£ã§ãã‚‹ã‚ˆã†ã€ãŸã¨ãˆè©±ã‚„èº«è¿‘ãªä¾‹ã‚’äº¤ãˆã¦èª¬æ˜ã™ã‚‹\n\nã€æœ€å¾Œã«ã€‘\nåˆå¿ƒè€…ãŒã•ã‚‰ã«ç†è§£ã‚’æ·±ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€\nã€Œä»–ã«ã©ã‚“ãªã“ã¨ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿä¾‹ãˆã°â€¦ã€ã¨ã„ã†å½¢ã§ã€è¿½åŠ ã®è³ªå•ä¾‹ã‚’ã„ãã¤ã‹æç¤ºã—ã¦ãã ã•ã„ã€‚\n----------------------------`; }

    function buildPromptCompare(unit, A, B, erA, erB, mode){ const TA=A.ca+A.fa, TB=B.ca+B.fa; const crA=A.cl?A.ca/A.cl*100:0, crB=B.cl?B.ca/B.cl*100:0; const gpmA=A.sales?(A.sales-A.cogs)/A.sales*100:0, gpmB=B.sales?(B.sales-B.cogs)/B.sales*100:0; const opmA=A.sales?A.op/A.sales*100:0, opmB=B.sales?B.op/B.sales*100:0; const erLabel=(mode==='principle')?'åŸå‰‡':'ç°¡ç•¥'; return `--- AIè§£é‡ˆç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ---\nä»¥ä¸‹ã¯2ç¤¾ï¼ˆ${A.company} ã¨ ${B.company}ï¼‰ã®è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚æ¥­ç¨®ã¯ä¼šç¤¾åã‹ã‚‰æ¨å®šã—ã¦ãã ã•ã„ã€‚\n\nåˆå¿ƒè€…å‘ã‘ã«ã€ä¸¡ç¤¾ã®è²¡å‹™æ§‹é€ ã¨åç›Šæ€§ã®é•ã„ã‚’ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜ã—ã€çŸ­æœŸå®‰å…¨æ€§ï¼ˆæµå‹•æ¯”ç‡ï¼‰ã¨é•·æœŸå®‰å…¨æ€§ï¼ˆè‡ªå·±è³‡æœ¬æ¯”ç‡ï¼‰ã«ã‚‚è§¦ã‚Œã¦ãã ã•ã„ã€‚\n\n--- ãƒ‡ãƒ¼ã‚¿ï¼ˆ${A.company}ï¼‰ ---\nç·è³‡ç”£ï¼š${fmt(TA)}${unit}ï¼ˆæµå‹• ${fmt(A.ca)}ï¼å›ºå®š ${fmt(A.fa)}ï¼‰\nè² å‚µåˆè¨ˆï¼š${fmt(A.cl+A.fl)}${unit}ï¼ˆæµå‹• ${fmt(A.cl)}ï¼å›ºå®š ${fmt(A.fl)}ï¼‰\nç´”è³‡ç”£ï¼š${fmt(A.na)}${unit}ï¼è‡ªå·±è³‡æœ¬æ¯”ç‡ï¼ˆ${erLabel}ï¼‰ï¼š${pct(erA)}ï¼æµå‹•æ¯”ç‡ï¼š${pct(crA)}\nå£²ä¸Šé«˜ï¼š${fmt(A.sales)}${unit}ï¼å£²ä¸Šç·åˆ©ç›Šç‡ï¼š${pct(gpmA)}ï¼å–¶æ¥­åˆ©ç›Šç‡ï¼š${pct(opmA)}\n\n--- ãƒ‡ãƒ¼ã‚¿ï¼ˆ${B.company}ï¼‰ ---\nç·è³‡ç”£ï¼š${fmt(TB)}${unit}ï¼ˆæµå‹• ${fmt(B.ca)}ï¼å›ºå®š ${fmt(B.fa)}ï¼‰\nè² å‚µåˆè¨ˆï¼š${fmt(B.cl+B.fl)}${unit}ï¼ˆæµå‹• ${fmt(B.cl)}ï¼å›ºå®š ${fmt(B.fl)}ï¼‰\nç´”è³‡ç”£ï¼š${fmt(B.na)}${unit}ï¼è‡ªå·±è³‡æœ¬æ¯”ç‡ï¼ˆ${erLabel}ï¼‰ï¼š${pct(erB)}ï¼æµå‹•æ¯”ç‡ï¼š${pct(crB)}\nå£²ä¸Šé«˜ï¼š${fmt(B.sales)}${unit}ï¼å£²ä¸Šç·åˆ©ç›Šç‡ï¼š${pct(gpmB)}ï¼å–¶æ¥­åˆ©ç›Šç‡ï¼š${pct(opmB)}\n--------------\n\nã€ãŠé¡˜ã„ã—ãŸã„ã“ã¨ã€‘\n1. è²¡å‹™å®‰å…¨æ€§ã®é•ã„ï¼ˆçŸ­æœŸãƒ»é•·æœŸï¼‰\n2. åç›Šæ€§ã®é•ã„ï¼ˆç²—åˆ©ç‡ãƒ»å–¶æ¥­åˆ©ç›Šç‡ï¼‰\n3. è¦æ¨¡ã¨å®‰å®šæ€§ã®ãƒãƒ©ãƒ³ã‚¹\n4. æ¥­ç•Œå¹³å‡ã¨æ¯”ã¹ãŸå¼·ã¿ãƒ»å¼±ã¿\n\nã€æœ€å¾Œã«ã€‘\nåˆå¿ƒè€…ãŒã•ã‚‰ã«ç†è§£ã‚’æ·±ã‚ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€\nã€Œä»–ã«ã©ã‚“ãªã“ã¨ã‚’çŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿä¾‹ãˆã°â€¦ã€ã¨ã„ã†å½¢ã§ã€è¿½åŠ ã®è³ªå•ä¾‹ã‚’ã„ãã¤ã‹æç¤ºã—ã¦ãã ã•ã„ã€‚\n----------------------------`; }

    function toggleModeUI(){ const mode=readMainMode(); $('companyBBlock').classList.toggle('hidden', mode!=='compare'); $('compareTypeBlock').classList.toggle('hidden', mode!=='compare'); clearAllLegends(); $('captureSingle').classList.add('hidden'); $('captureCompare').classList.add('hidden'); $('btnExport').disabled=true; $('msg').textContent=''; $('promptArea').value=''; }

    // ---- bootstrap ----
    window.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('input[name="mode"]').forEach(r=>r.addEventListener('change', ()=>{ toggleModeUI(); }));
      document.querySelectorAll('input[name="erMode"]').forEach(r=>r.addEventListener('change', ()=>{ if(!$('captureSingle').classList.contains('hidden')||!$('captureCompare').classList.contains('hidden')) render(); }));
      document.querySelectorAll('input[name="compareType"]').forEach(r=>r.addEventListener('change', ()=>{ if(readMainMode()==='compare') render(); }));
      $('btnGenerate').addEventListener('click', render);
      $('btnReset').addEventListener('click', ()=>{ location.reload(); });
      $('btnExport').addEventListener('click', async ()=>{ const mode=readMainMode(); const node=(mode==='compare')?$('captureCompare'):$('captureSingle'); $('btnExport').disabled=true; const canvas=await html2canvas(node,{backgroundColor:'#ffffff',scale:2}); $('btnExport').disabled=false; const compA=($('companyA').value||'A').replace(/\s+/g,'_'); const fyA=($('fiscalA').value||'FY').replace(/\s+/g,'_'); let fname=`BS-PL_${compA}_${fyA}.png`; if(mode==='compare'){ const compB=($('companyB').value||'B').replace(/\s+/g,'_'); const ct=readCompareType()==='ratio'?'ratio':'scale'; fname=`BS-PL_${compA}_vs_${compB}_${ct}.png`; } canvas.toBlob(b=>{ const url=URL.createObjectURL(b); const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },200); }); });
      $('btnCopy').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText($('promptArea').value); $('copyMsg').textContent='ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'; }catch{ const ta=$('promptArea'); ta.focus(); ta.select(); document.execCommand('copy'); $('copyMsg').textContent='ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆæ—§æ–¹å¼ï¼‰'; } });
      toggleModeUI();
    });

    function render(){ (readMainMode()==='compare')?renderCompare():renderSingle(); }
  </script>
</body>
</html>
